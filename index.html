<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Florida Springs Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  #map { height: 100%; }
  .filter-container {
    position: absolute;
    top: 70px; 
    left: 10px;
    z-index: 1000;
    font-size: 14px;
  }
  .filter-box {
    background: white;
    padding: 8px;
    border-radius: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    margin-top: 5px;
    display: none;
    max-height: 70vh;
    overflow-y: auto;
  }
  .toggle-btn {
    background: #0078d7;
    color: white;
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }
  .toggle-btn:hover {
    background: #005a9e;
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="filter-container">
  <button class="toggle-btn" onclick="toggleFilter()">☰ Filters</button>
  <div class="filter-box" id="filterBox">
    <strong>Filter by Magnitude:</strong><br>
  </div>
  <div class="filter-box" id="publicFilterBox">
    <strong>Filter by Public Access:</strong><br>
    <input type="checkbox" id="publicYes" checked> Public<br>
    <input type="checkbox" id="publicNo" checked> Private/Restricted<br>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
const map = L.map('map').setView([28.3, -82.0], 6);

// Base layers
const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);
const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri & contributors' });
const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Map data ©2025 Google', maxZoom: 20 });

// Layer control
L.control.layers({ "Street Map": streetLayer, "Satellite": satelliteLayer, "Hybrid": googleHybrid }).addTo(map);

// Search
L.Control.geocoder({ defaultMarkGeocode: true, placeholder: "Search address..." }).addTo(map);

// Marker cluster
let allMarkers = {};
let markerCluster = L.markerClusterGroup();
map.addLayer(markerCluster);

// Toggle filter box
function toggleFilter() {
  const box = document.getElementById('filterBox');
  const pubBox = document.getElementById('publicFilterBox');
  const display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
  box.style.display = display;
  pubBox.style.display = display;
}

// Magnitude checkboxes
function createMagnitudeCheckboxes() {
  const filterBox = document.getElementById('filterBox');
  for (let mag = 1; mag <= 8; mag++) {
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'filter-checkbox';
    cb.value = mag.toString();
    cb.checked = true;
    cb.onchange = updateMarkers;

    const label = document.createElement('label');
    label.style.marginLeft = "4px";
    label.appendChild(cb);
    label.appendChild(document.createTextNode(' Magnitude ' + mag));
    filterBox.appendChild(label);
    filterBox.appendChild(document.createElement('br'));
  }
}

// Update markers by magnitude and public access
function updateMarkers() {
  markerCluster.clearLayers();
  const checkedMagnitudes = Array.from(document.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
  const showPublic = document.getElementById('publicYes').checked;
  const showPrivate = document.getElementById('publicNo').checked;

  for (let mag in allMarkers) {
    if (checkedMagnitudes.includes(mag)) {
      allMarkers[mag].forEach(marker => {
        const isPublic = marker.feature?.properties.PUBLIC_ACCESS ?? true; 
        if ((isPublic && showPublic) || (!isPublic && showPrivate)) {
          markerCluster.addLayer(marker);
        }
      });
    }
  }
}

// Public access events
document.getElementById('publicYes').onchange = updateMarkers;
document.getElementById('publicNo').onchange = updateMarkers;

// Create marker, color by public access
function createMarker(feature) {
  const mag = feature.properties.MAGNITUDE || 'Unknown';
  const isPublic = feature.properties.PUBLIC_ACCESS ?? true;
  const color = isPublic ? 'cyan' : 'magenta';

  const marker = L.circleMarker(
    [feature.geometry.coordinates[1], feature.geometry.coordinates[0]],
    { radius: 6, fillColor: color, color: '#000', weight: 1, opacity: 1, fillOpacity: 0.9 }
  ).bindPopup(
    `<b>${feature.properties.SPRING_NAME || 'Unnamed'}</b><br>
     County: ${feature.properties.COUNTY || '—'}<br>
     Magnitude: ${mag}<br>
     Public Access: ${isPublic ? 'Yes' : 'No'}`
  );
  marker.feature = feature;
  return marker;
}

// Initialize checkboxes
createMagnitudeCheckboxes();

// Fetch DEP springs data
fetch('https://ca.dep.state.fl.us/arcgis/rest/services/OpenData/SPRINGS/MapServer/1/query?where=1%3D1&outFields=SPRING_NAME,COUNTY,MAGNITUDE,PUBLIC_ACCESS&f=geojson')
  .then(r => r.json())
  .then(data => {
    data.features.forEach(feature => {
      const mag = feature.properties.MAGNITUDE || 'Unknown';
      const marker = createMarker(feature);
      if (!allMarkers[mag]) allMarkers[mag] = [];
      allMarkers[mag].push(marker);
    });

    // Add Juniper Springs manually
    const juniperFeature = {
      geometry: { type: "Point", coordinates: [-81.7120, 29.1839] },
      properties: { SPRING_NAME: "Juniper Springs", COUNTY: "Marion", MAGNITUDE: 2, PUBLIC_ACCESS: true }
    };
    const juniperMarker = createMarker(juniperFeature);
    if (!allMarkers[2]) allMarkers[2] = [];
    allMarkers[2].push(juniperMarker);

    updateMarkers();
  });
</script>
</body>
</html>
